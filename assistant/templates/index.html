<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Store Assistant</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .chat-container {
            border: 1px solid #ddd;
            border-radius: 10px;
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #fafafa;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
        }
        .user-message {
            background-color: #007bff;
            color: white;
            text-align: right;
        }
        .ai-message {
            background-color: #e9ecef;
            color: #333;
        }
        .input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #questionInput {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
        }
        #askButton, #voiceButton {
            padding: 15px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
        }
        #askButton {
            background-color: #007bff;
            color: white;
        }
        #voiceButton {
            background-color: #28a745;
            color: white;
        }
        #askButton:hover {
            background-color: #0056b3;
        }
        #voiceButton:hover {
            background-color: #218838;
        }
        .recording {
            background-color: #dc3545 !important;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¤ AI Store Assistant</h1>
        <div id="chatContainer" class="chat-container">
            <div class="message ai-message">
                Hello! I'm your AI store assistant. You can ask me about products, prices, or anything related to our store. How can I help you today?
            </div>
        </div>
        <div class="input-container">
            <input type="text" id="questionInput" placeholder="Type your question here..." />
            <button id="askButton">Send</button>
            <button id="voiceButton">ðŸŽ¤ Speak</button>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chatContainer');
        const questionInput = document.getElementById('questionInput');
        const askButton = document.getElementById('askButton');
        const voiceButton = document.getElementById('voiceButton');

        let recognition;
        let isRecording = false;

        // Initialize speech recognition if available
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = function() {
                isRecording = true;
                voiceButton.textContent = 'ðŸ”´ Recording...';
                voiceButton.classList.add('recording');
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                questionInput.value = transcript;
                // Automatically ask the question after transcription
                setTimeout(() => {
                    askQuestion();
                }, 500);
            };

            recognition.onend = function() {
                isRecording = false;
                voiceButton.textContent = 'ðŸŽ¤ Speak';
                voiceButton.classList.remove('recording');
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                isRecording = false;
                voiceButton.textContent = 'ðŸŽ¤ Speak';
                voiceButton.classList.remove('recording');
                addMessage('Voice recognition error. Please try typing your question.', 'ai-message');
            };
        } else {
            voiceButton.style.display = 'none';
        }

        function addMessage(text, className) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`;
            messageDiv.textContent = text;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message ai-message loading';
            loadingDiv.textContent = 'Thinking...';
            loadingDiv.id = 'loading';
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hideLoading() {
            const loadingDiv = document.getElementById('loading');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // Function to get the best English voice
        function getBestEnglishVoice() {
            const voices = speechSynthesis.getVoices();
            
            // Prefer US English voices
            const usEnglish = voices.find(voice => 
                voice.lang === 'en-US' && voice.name.toLowerCase().includes('english')
            );
            if (usEnglish) return usEnglish;
            
            // Fallback to any US English voice
            const anyUSEnglish = voices.find(voice => voice.lang === 'en-US');
            if (anyUSEnglish) return anyUSEnglish;
            
            // Fallback to any English voice
            const anyEnglish = voices.find(voice => voice.lang.startsWith('en'));
            if (anyEnglish) return anyEnglish;
            
            return null;
        }

        async function askQuestion() {
            const question = questionInput.value.trim();
            if (!question) return;

            // Add user message
            addMessage(question, 'user-message');
            questionInput.value = '';

            // Show loading
            showLoading();

            try {
                const response = await fetch(`/assistant/ask/?q=${encodeURIComponent(question)}`);
                const data = await response.json();

                hideLoading();

                if (data.error) {
                    addMessage(`Error: ${data.error}`, 'ai-message');
                } else {
                    addMessage(data.answer, 'ai-message');
                    
                    // Text-to-speech for the response
                    if ('speechSynthesis' in window) {
                        // Wait a bit for voices to load
                        setTimeout(() => {
                            const utterance = new SpeechSynthesisUtterance(data.answer);
                            utterance.lang = 'en-US';
                            utterance.rate = 0.9;
                            utterance.pitch = 1.0;
                            
                            const bestVoice = getBestEnglishVoice();
                            if (bestVoice) {
                                utterance.voice = bestVoice;
                                console.log('Using voice:', bestVoice.name);
                            }
                            
                            speechSynthesis.speak(utterance);
                        }, 100);
                    }
                }
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                addMessage('Error connecting to the assistant. Please try again.', 'ai-message');
            }
        }

        // Load voices when they become available
        if ('speechSynthesis' in window) {
            speechSynthesis.addEventListener('voiceschanged', function() {
                console.log('Voices loaded:', speechSynthesis.getVoices().length);
            });
            
            // Force load voices
            speechSynthesis.getVoices();
        }

        // Event listeners
        askButton.addEventListener('click', askQuestion);

        questionInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                askQuestion();
            }
        });

        voiceButton.addEventListener('click', function() {
            if (!recognition) {
                alert('Voice recognition is not available in your browser.');
                return;
            }

            if (isRecording) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('Recognition start error:', error);
                    addMessage('Could not start voice recognition. Please try again.', 'ai-message');
                }
            }
        });
    </script>
</body>
</html>
